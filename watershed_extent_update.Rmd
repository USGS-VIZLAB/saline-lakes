---
title: "End of Summer Report"
author: |
  | Data Science Branch, IIDD, USGS WMA 
  | Contacts: Margaux Sleckman (msleckman@usgs.gov), Anthony Martinez (ajmartinez@usgs.gov) and Cee Nell (cnell@usgs.gov)
  
date: "9/01/2022"
output: html_document
---

The purpose of this document is to establish an agreed upon spatial extent for each of the saline lakes, including:

1. Lake polygons - incl. Carson Sink
2. Updated Watershed boundaries
3. Upstream flowlines within each watershed

Data source table: 

| Feature  |Source/Database | Notes     |
| ---------|----------|-----------| 
|Water Bodies |[National Hydrological Dataset - high res](https://www.usgs.gov/national-hydrography/nhdplus-high-resolution) - water body attributes | Carson sink was manually drawn 
| Huc | [National Hydrological Dataset - high res](https://www.usgs.gov/national-hydrography/nhdplus-high-resolution) - HUC6,8,10,12 | X
|Flowlines | [National Hydrological Dataset - medium res](https://www.usgs.gov/national-hydrography/nhdplus) - NHDFLowlines
| Gauge sites | NWIS |
| field measurements | NWIS |  

#### Definitions: 

Geospatial features: 
  * Water body and watershed extent definitions:

    * **Saline Lake: ** Lake polygon, outlined by the border of the water body feature
    * **Lake boundary and Wetlands:** * Broader outline of our focal lakes that includes lake wetlands
    * **Watershed Extents:** Extent of the lake's watershed containing 

_* not yet created_

### Defining watershed extents: Steps:

**Watershed Extent**
  1. Identified HUC6: basin of each lake
  2. Collected all the huc8 and huc10s within those HUC6 
  3. Created spreadsheet mapping Huc6,Hu8,and Huc10 associated with each lake (see sharepoint excel [here](https://doimspp.sharepoint.com/:x:/s/IIDDStaff/EdhaQ9_tsPNIhW32hI9nydAB9RO5CDXSHx3yGLVWtaxwNA?e=wl8wS4)), then reviewed and consulted on theses HU to identify the units considered within a given lake's watershed scope. 
    In some cases, the watershed of a given lake is the entire HUC6 within which that lake belong's to (e.g. Pyramid Lake,     CA), this is the default if no more precise information is provided. In other cases, the watershed of a given lake         comprises of one or several huc10s (Eagle Lake, CA). Our output watershed extent shapefile is displayed by the layer       Watershed Extent.

Layer definitions: 
 Great Basin HUC6:
 Great Basin HUC8:
 Great Basin HUC10:
 Saline lakes:
 Watershed Extent:
 Watershed Extent by huc10:
 Watershed Extent v2:


```{r load_lbs, echo = FALSE,message = FALSE, warnings = FALSE} 

library(targets)
library(leaflet)
library(scico)
library(scales)
library(dplyr)
#library(vctrs)
library(rmapshaper)

source('3_visualize/src/prep_viz_data.R')
source('3_visualize/src/interactive_map.R')

```


```{r load_targets, echo = FALSE, message = FALSE, warnings = FALSE}

## HUC
tar_load(p1_get_lakes_huc6_sf)
tar_load(p1_get_lakes_huc8_sf)
tar_load(p1_get_lakes_huc10_sf)

## Lakes
tar_load(p2_saline_lakes_sf)
tar_load(p3_saline_lakes_sf)

## Watershed 
tar_load(p2_huc10_watershed_boundary)
tar_load(p2_huc10_watershed_boundary_no_humbolt_huc6)
tar_load(p2_lake_watersheds_dissolved)
tar_load(p2_lake_watersheds_dissolved_no_humbolt_huc6)

## flowlines
tar_load(p2_lake_tributaries)
tar_load(p3_flowlines_sf)

## Sites 
targets::tar_load(p3_gage_sites_sf)
targets::tar_load(p1_site_in_watersheds_sf)

## nwis data 
targets::tar_load(p1_nwis_dv_sw_data)
targets::tar_load(p1_nwis_meas_sw_data)

```



### Defining watershed extents: Map
```{r huc_basins, message =FALSE, echo = FALSE, warnings = FALSE}

leaflet_map_huc <- leaflet() %>% 
  addProviderTiles("Esri.WorldGrayCanvas", group = c("No labels", "Labels"))  %>%
    #addProviderTiles("HERE.satelliteDay", group = c("No labels", "Labels"))  %>%
    addProviderTiles("CartoDB.PositronOnlyLabels", group = "Labels") %>%
    ## NOTE - compared to previos version of function - I've removed label param (no label column like below)
      # Add data layers (overlayGroups)
    addPolygons(data = p1_get_lakes_huc6_sf %>% ms_simplify(), group = "Great Basin HUC6",
                color = 'green', fillColor = "#C3CB9F", opacity = 0.4, weight = 1) %>% 
    addPolygons(data = p1_get_lakes_huc8_sf %>% ms_simplify(), group = "Great Basin HUC8",
                color = 'blue', fillColor = "#C3CB9F", opacity = 0.4, weight = 1) %>% 
    addPolygons(data = p1_get_lakes_huc10_sf %>% ms_simplify(), group = "Great Basin HUC10",
                color = '#3A6DB7', opacity = 0.4, weight = 1) %>% 
    addPolygons(data = p2_huc10_watershed_boundary %>% ms_simplify(), group = "Watershed Extent by huc10",
                color = 'black', opacity = 0.4, weight = 2) %>%
    addPolygons(data = p2_lake_watersheds_dissolved, group = "Watershed Extent",
                color = 'black', opacity = 0.4, weight = 3) %>% 
    addPolygons(data = p2_lake_watersheds_dissolved_no_humbolt_huc6, group = "Watershed Extent v2",
                color = 'black', fillColor = "#C3CB9F", opacity = 0.4, weight = 3) %>% 
    addPolygons(data = p3_saline_lakes_sf, group = "Saline lakes",
                color = '#3A6DB7', opacity = 0.6, weight = 1,
                popup = ~label) %>% 
      addLabelOnlyMarkers(data = p3_saline_lakes_sf, lng = ~X, lat = ~Y, group = "Lake labels",
                        label = ~lake_w_state,
                        labelOptions = labelOptions(noHide = T, textOnly = T)) %>% 
    # addLegend(data = , group = c("Watershed"),
    #            title = "Within saline lake subbasin",
    #            pal = pal_gage, values = ~in_HUC8,
    #            position = "bottomright") %>%
  addLayersControl(baseGroups = c("Labels", "No Labels"),
                     overlayGroups = c("Saline lakes", "Great Basin HUC6", "Great Basin HUC8", "Great Basin HUC10", "Watershed Extent","Watershed Extent v2",
                                       "Watershed Extent by huc10", "Lake labels"),
                     position = "topright",
                     options = layersControlOptions(collapsed = F))

```


```{r message =FALSE, echo = FALSE, warnings = FALSE, out.width = '100%'}

leaflet_map_huc

```


_Note: Watershed Extent V.2 is an alternative Watershed Extent layer that excludes the large HUC6:Humboldt. this HUC6 overlaps with Carson Sink, however may deem this area out of the lake's watershed scope do to size)._ 

You may explore the following map to visualize the different HUC areas within our basin and the final watershed extents determined after careful iteration on feedback. 

**Some initial questions:**

- **Carson Sink:** Carson Sink in the manner it is drawn overlaps with two HUC6 – since default is to take HUC6 – the basin of the lake – both HUC6-Humbolt and HUC6-Carson Desert basins are currently included as part of that lakes watershed extent. However, through quick review of literature, HUC6: Carson Desert seems to be the agreed-upon basin for Carson Sink. Is this correct? 

```{r message =FALSE, echo = FALSE, warnings = FALSE}

crsn_sk_bbox <- p2_lake_watersheds_dissolved %>%
  filter(lake_w_state == 'Carson Sink,NV') %>% 
  sf::st_bbox() %>% as.vector()

leaflet_map_crsn_sk <- leaflet() %>% 
  addProviderTiles("Esri.WorldGrayCanvas", group = c("No labels", "Labels"))  %>%
    #addProviderTiles("HERE.satelliteDay", group = c("No labels", "Labels"))  %>%
    addProviderTiles("CartoDB.PositronOnlyLabels", group = "Labels") %>%
  fitBounds(crsn_sk_bbox[1], crsn_sk_bbox[2], crsn_sk_bbox[3], crsn_sk_bbox[4]) %>% 
    ## NOTE - compared to previos version of function - I've removed label param (no label column like below)
      # Add data layers (overlayGroups)
    addPolygons(data = p2_lake_watersheds_dissolved, group = "Watershed Extent",
                color = 'black', opacity = 0.4, weight = 3) %>% 
    addPolygons(data = p2_lake_watersheds_dissolved_no_humbolt_huc6, group = "Watershed Extent v2",
                color = 'black', fillColor = "#C3CB9F", opacity = 0.4, weight = 3) %>% 
    addPolygons(data = p3_saline_lakes_sf, group = "Saline lakes",
                color = '#3A6DB7', opacity = 0.6, weight = 1,
                popup = ~label) %>% 
      addLabelOnlyMarkers(data = p3_saline_lakes_sf, lng = ~X, lat = ~Y, group = "Lake labels",
                        label = ~lake_w_state,
                        labelOptions = labelOptions(noHide = T, textOnly = T)) %>% 
  addLayersControl(baseGroups = c("Labels", "No Labels"),
                     overlayGroups = c("Saline lakes", "Watershed Extent","Watershed Extent v2",
                                       "Lake labels"),
                     position = "topright",
                     options = layersControlOptions(collapsed = F))

leaflet_map_crsn_sk

```

- **Sevier Lake, UT:** What Huc8's are included in Sevier Lake watershed? SHould it include Middle and Upper Sevier?

```{r message =FALSE, echo = FALSE, warnings = FALSE}

sevier_bbox <- p2_lake_watersheds_dissolved %>%
  filter(lake_w_state == 'Sevier Lake,UT') %>% 
  sf::st_bbox() %>% as.vector()

leaflet_map_sevier <- leaflet() %>% 
  addProviderTiles("Esri.WorldGrayCanvas", group = c("No labels", "Labels"))  %>%
    #addProviderTiles("HERE.satelliteDay", group = c("No labels", "Labels"))  %>%
    addProviderTiles("CartoDB.PositronOnlyLabels", group = "Labels") %>%
  fitBounds(sevier_bbox[1], sevier_bbox[2], sevier_bbox[3], sevier_bbox[4]) %>% 
    ## NOTE - compared to previos version of function - I've removed label param (no label column like below)
      # Add data layers (overlayGroups)
    addPolygons(data = p2_lake_watersheds_dissolved, group = "Watershed Extent",
                color = 'black', opacity = 0.4, weight = 3) %>% 
    addPolygons(data = p1_get_lakes_huc6_sf %>% ms_simplify(), group = "Great Basin HUC6",
                color = 'green', fillColor = "#C3CB9F", opacity = 0.4, weight = 1, popup = ~Name) %>% 
    addPolygons(data = p1_get_lakes_huc8_sf %>% ms_simplify(), group = "Great Basin HUC8",
                color = 'blue', fillColor = "#C3CB9F", opacity = 0.4, weight = 1, popup = ~Name) %>% 
    addPolygons(data = p3_saline_lakes_sf, group = "Saline lakes",
                color = '#3A6DB7', opacity = 0.6, weight = 1,
                popup = ~label) %>% 
      addLabelOnlyMarkers(data = p3_saline_lakes_sf, lng = ~X, lat = ~Y, group = "Lake labels",
                        label = ~lake_w_state,
                        labelOptions = labelOptions(noHide = T, textOnly = T)) %>% 
  addLayersControl(baseGroups = c("Labels", "No Labels"),
                     overlayGroups = c("Saline lakes", "Watershed Extent",
                                       "Great Basin HUC6","Great Basin HUC8",
                                       "Lake labels"),
                     position = "topright",
                     options = layersControlOptions(collapsed = F))

leaflet_map_sevier

```


### NWIS Sites and Flowlines Map
```{r lake_watershed_nwis_sites, message =FALSE, echo = FALSE, warnings = FALSE}

dv_sites_in_watershed <- p1_site_in_watersheds_sf %>%
  filter(site_no %in% unique( p1_nwis_dv_sw_data$site_no)) %>% 
  mutate(service = 'dv',
         label = paste(site_no,': ', station_nm))

field_meas_sites_in_watershed <- p1_site_in_watersheds_sf %>%
  filter(site_no %in% unique( p1_nwis_meas_sw_data$site_no)) %>% 
  mutate(service = 'measurements',
         label = paste(site_no,': ', station_nm))

  # Build map
  leaflet_map_sites <- leaflet() %>% 
    #Add Basemap (baseGroups)
    addProviderTiles("Esri.WorldGrayCanvas", group = c("No labels", "Labels"))  %>%
    #addProviderTiles("HERE.satelliteDay", group = c("No labels", "Labels"))  %>%
    addProviderTiles("CartoDB.PositronOnlyLabels", group = "Labels") %>%
    # Add data layers (overlayGroups)
    addPolygons(data = p2_lake_watersheds_dissolved,
                group = "Watershed Extent", color = 'black',
                fillColor = "#C3CB9F",
                opacity = 0.4, weight = 1,) %>% 
    addPolygons(data = p3_saline_lakes_sf, group = "Saline lakes",
                color = '#3A6DB7', opacity = 0.8, weight = 2,
                popup = ~label) %>%
        addCircleMarkers(data = dv_sites_in_watershed,
                         group = c("Gage sites (dv)"),
                         radius = 3, weight = 1,
                         color = 'grey',
                         fillColor = 'firebrick', popup = ~label) %>%
        addCircleMarkers(data = field_meas_sites_in_watershed,
                         group = c("Gage sites (field measurements)"),
                         radius = 3, weight = 1,
                          color = 'grey',
                         fillColor = 'green', popup = ~label) %>%
    addLabelOnlyMarkers(data = p3_saline_lakes_sf,
                        lng = ~X, lat = ~Y,
                        group = "Lake labels", label = ~lake_w_state,
                        labelOptions = labelOptions(noHide = T, textOnly = T)
                        ) %>% 
    addPolylines(data = p3_flowlines_sf, group = "Streams",
                 color = scico(9, palette = 'davos')[5], opacity = 0.8,
                 weight = ~rescale(streamorde, to = c(1, 4)),
                 popup = ~label) %>% 
    addLayersControl(baseGroups = c("Labels", "No Labels"),
                     overlayGroups = c("Saline lakes", "Lake labels",
                                       "Watershed Extent",
                                       "Gage sites (dv)",
                                       "Gage sites (field measurements)",
                                       'Streams'
                                       ),
                     position = "topright",
                     options = layersControlOptions(collapsed = F))
  
  
```


```{r message =FALSE, echo = FALSE, warnings = FALSE}

leaflet_map_sites

```

#### Observations 
Many of field measurements were made at nwis sites where dv data was collected. 
